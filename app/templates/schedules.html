{% extends "base.html" %}

{% block title %}Schedules - RedRat Proxy{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-md">
        <div class="border-b border-gray-200 px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Schedules</h1>
                    <p class="text-gray-600 mt-1">Manage scheduled command sequences</p>
                </div>
                <button onclick="showCreateScheduleModal()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-plus mr-2"></i>
                    Create Schedule
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <!-- Schedules List -->
            <div id="schedules-list" class="space-y-4">
                <!-- Schedules will be loaded here -->
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="text-center py-12 hidden">
                <div class="text-gray-400 text-6xl mb-4">
                    <i class="fas fa-clock"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No schedules yet</h3>
                <p class="text-gray-600" id="empty-state-message">Create sequences and schedule them to run automatically.</p>
                <div id="empty-state-actions" class="mt-4">
                    <a href="/sequences" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 mr-2">
                        <i class="fas fa-plus mr-2"></i>
                        Create Sequence
                    </a>
                    <button onclick="showCreateScheduleModal()" id="create-schedule-btn" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-calendar-plus mr-2"></i>
                        Create Schedule
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div id="editScheduleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Edit Schedule</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="editScheduleForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Schedule Type</label>
                    <select id="editScheduleType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="once">Once</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                
                <!-- Once scheduling options -->
                <div id="editOnceOptions" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date & Time</label>
                    <input type="datetime-local" id="editOnceDateTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Daily scheduling options -->
                <div id="editDailyOptions" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                    <input type="time" id="editDailyTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Weekly scheduling options -->
                <div id="editWeeklyOptions" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Day of Week</label>
                    <select id="editWeeklyDay" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                    <input type="time" id="editWeeklyTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Monthly scheduling options -->
                <div id="editMonthlyOptions" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Day of Month</label>
                    <input type="number" id="editMonthlyDay" min="1" max="31" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                    <input type="time" id="editMonthlyTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex items-center justify-end space-x-3">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                        Update Schedule
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Schedule Modal -->
<div id="createScheduleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Create New Schedule</h3>
                <button onclick="closeCreateModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="createScheduleForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sequence to Schedule</label>
                    <select id="createSequenceSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Loading sequences...</option>
                    </select>
                    <div id="noSequencesMessage" class="text-sm text-red-600 mt-1 hidden">
                        No sequences available. <a href="/sequences" class="text-blue-600 hover:underline">Create a sequence first</a>.
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Schedule Type</label>
                    <select id="createScheduleType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="once">Once</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                
                <!-- Once scheduling options -->
                <div id="createOnceOptions" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Date & Time</label>
                    <input type="datetime-local" id="createOnceDateTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Daily scheduling options -->
                <div id="createDailyOptions" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                    <input type="time" id="createDailyTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Weekly scheduling options -->
                <div id="createWeeklyOptions" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Day of Week</label>
                    <select id="createWeeklyDay" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                        <option value="0">Sunday</option>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                    </select>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                    <input type="time" id="createWeeklyTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Monthly scheduling options -->
                <div id="createMonthlyOptions" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Day of Month</label>
                    <input type="number" id="createMonthlyDay" min="1" max="31" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                    <input type="time" id="createMonthlyTime" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex items-center justify-end space-x-3">
                    <button type="button" onclick="closeCreateModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                        Create Schedule
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Common function to handle API calls with authentication
async function apiCall(url, options = {}) {
    try {
        const response = await fetch(url, options);
        
        if (response.status === 401) {
            // User is not authenticated, redirect to login
            window.location.href = '/login';
            return null;
        }
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response;
    } catch (error) {
        console.error('API call failed:', error);
        throw error;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadSchedules();
    loadSequencesForScheduling();
    
    async function loadSchedules() {
        try {
            const response = await apiCall('/api/schedules');
            
            if (!response) return; // User was redirected to login
            
            const data = await response.json();
            
            if (data.success) {
                renderSchedules(data.schedules);
            } else {
                showError('Failed to load schedules: ' + data.message);
            }
        } catch (error) {
            showError('Failed to load schedules: ' + error.message);
        }
    }
    
    function renderSchedules(schedules) {
        const schedulesList = document.getElementById('schedules-list');
        const emptyState = document.getElementById('empty-state');
        
        if (schedules.length === 0) {
            schedulesList.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        schedulesList.innerHTML = '';
        
        schedules.forEach(schedule => {
            const scheduleItem = document.createElement('div');
            scheduleItem.classList.add('bg-gray-50', 'rounded-lg', 'p-4', 'border', 'border-gray-200');
            
            const statusBadge = getStatusBadge(schedule.status);
            const typeBadge = getTypeBadge(schedule.type);
            
            scheduleItem.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            <h3 class="text-lg font-medium text-gray-900">${schedule.name}</h3>
                            ${statusBadge}
                            ${typeBadge}
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div><strong>Schedule:</strong> ${formatSchedule(schedule.schedule_type, schedule.schedule_data)}</div>
                            <div><strong>Next Run:</strong> ${schedule.next_run ? new Date(schedule.next_run).toLocaleString('en-GB', {hour12: false}) : 'Not set'}</div>
                            ${schedule.last_run ? `<div><strong>Last Run:</strong> ${new Date(schedule.last_run).toLocaleString('en-GB', {hour12: false})}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editSchedule('${schedule.id}')" class="text-blue-600 hover:text-blue-800" title="Edit Schedule">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteSchedule('${schedule.id}')" class="text-red-600 hover:text-red-800" title="Delete Schedule">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            schedulesList.appendChild(scheduleItem);
        });
    }
    
    function getStatusBadge(status) {
        const colors = {
            'active': 'bg-green-100 text-green-800',
            'paused': 'bg-yellow-100 text-yellow-800',
            'completed': 'bg-gray-100 text-gray-800',
            'pending': 'bg-blue-100 text-blue-800'
        };
        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colors[status] || 'bg-gray-100 text-gray-800'}">${status}</span>`;
    }
    
    function getTypeBadge(type) {
        const colors = {
            'sequence': 'bg-purple-100 text-purple-800',
            'command': 'bg-blue-100 text-blue-800'
        };
        return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colors[type] || 'bg-gray-100 text-gray-800'}">${type}</span>`;
    }
    
    function formatSchedule(scheduleType, scheduleData) {
        try {
            const data = typeof scheduleData === 'string' ? JSON.parse(scheduleData) : scheduleData;
            
            switch (scheduleType) {
                case 'once':
                    return `Once at ${data.datetime ? new Date(data.datetime).toLocaleString('en-GB', {hour12: false}) : 'Not set'}`;
                case 'daily':
                    return `Daily at ${data.time || 'Not set'}`;
                case 'weekly':
                    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    return `Weekly on ${days[data.day] || 'Unknown'} at ${data.time || 'Not set'}`;
                case 'monthly':
                    return `Monthly on day ${data.day || 'Unknown'} at ${data.time || 'Not set'}`;
                default:
                    return scheduleType;
            }
        } catch (e) {
            return scheduleType;
        }
    }
    
    // Global variable to store available sequences
    let availableSequences = [];
    
    async function loadSequencesForScheduling() {
        try {
            const response = await apiCall('/api/sequences');
            if (!response) return;
            
            const data = await response.json();
            if (data.success) {
                availableSequences = data.sequences;
                updateEmptyStateBasedOnSequences();
            }
        } catch (error) {
            console.error('Failed to load sequences:', error);
        }
    }
    
    function updateEmptyStateBasedOnSequences() {
        const createScheduleBtn = document.getElementById('create-schedule-btn');
        const emptyStateMessage = document.getElementById('empty-state-message');
        
        if (availableSequences.length === 0) {
            emptyStateMessage.textContent = 'No sequences available to schedule. Create sequences first, then schedule them to run automatically.';
            createScheduleBtn.style.display = 'none';
        } else {
            emptyStateMessage.textContent = 'Create sequences and schedule them to run automatically.';
            createScheduleBtn.style.display = 'inline-flex';
        }
    }
    
    window.showCreateScheduleModal = async function() {
        if (availableSequences.length === 0) {
            showError('No sequences available. Please create a sequence first.');
            return;
        }
        
        // Populate sequence dropdown
        const sequenceSelect = document.getElementById('createSequenceSelect');
        sequenceSelect.innerHTML = '<option value="">Select a sequence...</option>';
        
        availableSequences.forEach(sequence => {
            const option = document.createElement('option');
            option.value = sequence.id;
            option.textContent = `${sequence.name} (${sequence.commands?.length || 0} commands)`;
            sequenceSelect.appendChild(option);
        });
        
        // Reset form
        document.getElementById('createScheduleForm').reset();
        document.getElementById('createScheduleType').value = 'daily';
        showCreateScheduleOptions('daily');
        
        // Show modal
        document.getElementById('createScheduleModal').classList.remove('hidden');
    };
    
    window.closeCreateModal = function() {
        document.getElementById('createScheduleModal').classList.add('hidden');
    };
    
    function showCreateScheduleOptions(scheduleType) {
        // Hide all options first
        document.getElementById('createOnceOptions').classList.add('hidden');
        document.getElementById('createDailyOptions').classList.add('hidden');
        document.getElementById('createWeeklyOptions').classList.add('hidden');
        document.getElementById('createMonthlyOptions').classList.add('hidden');
        
        // Show relevant options
        if (scheduleType === 'once') {
            document.getElementById('createOnceOptions').classList.remove('hidden');
        } else if (scheduleType === 'daily') {
            document.getElementById('createDailyOptions').classList.remove('hidden');
        } else if (scheduleType === 'weekly') {
            document.getElementById('createWeeklyOptions').classList.remove('hidden');
        } else if (scheduleType === 'monthly') {
            document.getElementById('createMonthlyOptions').classList.remove('hidden');
        }
    }
    
    // Handle create form submission
    document.getElementById('createScheduleForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const sequenceId = document.getElementById('createSequenceSelect').value;
        if (!sequenceId) {
            showError('Please select a sequence to schedule');
            return;
        }
        
        const scheduleType = document.getElementById('createScheduleType').value;
        let scheduleData = {};
        
        if (scheduleType === 'once') {
            const datetime = document.getElementById('createOnceDateTime').value;
            if (!datetime) {
                showError('Please select a date and time');
                return;
            }
            scheduleData.datetime = datetime;
        } else if (scheduleType === 'daily') {
            const time = document.getElementById('createDailyTime').value;
            if (!time) {
                showError('Please select a time');
                return;
            }
            scheduleData.time = time + ':00';
        } else if (scheduleType === 'weekly') {
            const day = document.getElementById('createWeeklyDay').value;
            const time = document.getElementById('createWeeklyTime').value;
            if (!time) {
                showError('Please select a time');
                return;
            }
            scheduleData.day = parseInt(day);
            scheduleData.time = time + ':00';
        } else if (scheduleType === 'monthly') {
            const day = document.getElementById('createMonthlyDay').value;
            const time = document.getElementById('createMonthlyTime').value;
            if (!day || !time) {
                showError('Please select a day and time');
                return;
            }
            scheduleData.day = parseInt(day);
            scheduleData.time = time + ':00';
        }
        
        try {
            const response = await apiCall('/api/schedules', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    type: 'sequence',
                    target_id: sequenceId,
                    schedule_type: scheduleType,
                    schedule_data: scheduleData
                })
            });
            
            if (!response) return;
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess('Schedule created successfully');
                closeCreateModal();
                loadSchedules();
            } else {
                showError('Failed to create schedule: ' + data.message);
            }
        } catch (error) {
            showError('Failed to create schedule: ' + error.message);
        }
    });
    
    // Handle schedule type change in create modal
    document.getElementById('createScheduleType').addEventListener('change', function() {
        showCreateScheduleOptions(this.value);
    });

    window.deleteSchedule = async function(scheduleId) {
        if (!confirm('Are you sure you want to delete this schedule?')) {
            return;
        }
        
        try {
            const response = await apiCall(`/api/schedules/${scheduleId}`, {
                method: 'DELETE'
            });
            
            if (!response) return; // User was redirected to login
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess('Schedule deleted successfully');
                loadSchedules();
            } else {
                showError('Failed to delete schedule: ' + data.message);
            }
        } catch (error) {
            showError('Failed to delete schedule: ' + error.message);
        }
    };
    
    window.editSchedule = async function(scheduleId) {
        try {
            // Get the schedule data first
            const response = await apiCall('/api/schedules');
            if (!response) return;
            
            const data = await response.json();
            const schedule = data.schedules.find(s => s.id === scheduleId);
            
            if (!schedule) {
                showError('Schedule not found');
                return;
            }
            
            // Store the schedule ID for updating
            document.getElementById('editScheduleForm').dataset.scheduleId = scheduleId;
            
            // Populate the form
            document.getElementById('editScheduleType').value = schedule.schedule_type;
            
            // Show appropriate options based on schedule type
            showEditScheduleOptions(schedule.schedule_type);
            
            // Populate schedule-specific fields
            const scheduleData = typeof schedule.schedule_data === 'string' ? 
                JSON.parse(schedule.schedule_data) : schedule.schedule_data;
            
            if (schedule.schedule_type === 'once') {
                document.getElementById('editOnceDateTime').value = scheduleData.datetime || '';
            } else if (schedule.schedule_type === 'daily') {
                document.getElementById('editDailyTime').value = scheduleData.time || '';
            } else if (schedule.schedule_type === 'weekly') {
                document.getElementById('editWeeklyDay').value = scheduleData.day || '0';
                document.getElementById('editWeeklyTime').value = scheduleData.time || '';
            } else if (schedule.schedule_type === 'monthly') {
                document.getElementById('editMonthlyDay').value = scheduleData.day || '1';
                document.getElementById('editMonthlyTime').value = scheduleData.time || '';
            }
            
            // Show the modal
            document.getElementById('editScheduleModal').classList.remove('hidden');
            
        } catch (error) {
            showError('Failed to load schedule data: ' + error.message);
        }
    };
    
    function showEditScheduleOptions(scheduleType) {
        // Hide all options first
        document.getElementById('editOnceOptions').classList.add('hidden');
        document.getElementById('editDailyOptions').classList.add('hidden');
        document.getElementById('editWeeklyOptions').classList.add('hidden');
        document.getElementById('editMonthlyOptions').classList.add('hidden');
        
        // Show relevant options
        if (scheduleType === 'once') {
            document.getElementById('editOnceOptions').classList.remove('hidden');
        } else if (scheduleType === 'daily') {
            document.getElementById('editDailyOptions').classList.remove('hidden');
        } else if (scheduleType === 'weekly') {
            document.getElementById('editWeeklyOptions').classList.remove('hidden');
        } else if (scheduleType === 'monthly') {
            document.getElementById('editMonthlyOptions').classList.remove('hidden');
        }
    }
    
    window.closeEditModal = function() {
        document.getElementById('editScheduleModal').classList.add('hidden');
    };
    
    // Handle edit form submission
    document.getElementById('editScheduleForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const scheduleId = this.dataset.scheduleId;
        const scheduleType = document.getElementById('editScheduleType').value;
        
        let scheduleData = {};
        
        if (scheduleType === 'once') {
            scheduleData.datetime = document.getElementById('editOnceDateTime').value;
        } else if (scheduleType === 'daily') {
            scheduleData.time = document.getElementById('editDailyTime').value + ':00';
        } else if (scheduleType === 'weekly') {
            scheduleData.day = parseInt(document.getElementById('editWeeklyDay').value);
            scheduleData.time = document.getElementById('editWeeklyTime').value + ':00';
        } else if (scheduleType === 'monthly') {
            scheduleData.day = parseInt(document.getElementById('editMonthlyDay').value);
            scheduleData.time = document.getElementById('editMonthlyTime').value + ':00';
        }
        
        try {
            const response = await apiCall(`/api/schedules/${scheduleId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    schedule_type: scheduleType,
                    schedule_data: scheduleData
                })
            });
            
            if (!response) return;
            
            const data = await response.json();
            
            if (data.success) {
                showSuccess('Schedule updated successfully');
                closeEditModal();
                loadSchedules();
            } else {
                showError('Failed to update schedule: ' + data.message);
            }
        } catch (error) {
            showError('Failed to update schedule: ' + error.message);
        }
    });
    
    // Handle schedule type change in edit modal
    document.getElementById('editScheduleType').addEventListener('change', function() {
        showEditScheduleOptions(this.value);
    });
    
    function showSuccess(message) {
        alert(message);
    }
    
    function showError(message) {
        alert('Error: ' + message);
    }
});
</script>
{% endblock %}
